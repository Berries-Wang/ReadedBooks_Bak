# 类文件结构
## 无关性基石
+ 各种不同平台的虚拟机与所有平台都同一使用的程序存储格式——字节码（ByteCode）是构成平台无关性基石
### 无关性
+ Java:平台无关性(可运行于Unix、Linux、Windows)
+ JVM:语言无关性(jvm只加载.class文件执行)
+ Java虚拟机不和包括Java在内的任何语言绑定，只会与**Class文件**相关联(**JVM不管class来源于何种语言**)。.class文件包含JVM指令集和符号表以及若干其他辅助信息 
## Class类文件结构
+ 任何一个Class文件都对应着唯一一个类或者接口的定义信息，但反过来说，类或者接口不一定要定义在Class文件中，也可以通过类加载器直接生成
+ Class文件是一组以8位字节为基础单位的二进制流，各个数据项目严格按照顺序紧凑地排列在Class文件之中，中间没有任何的分隔符。
+ Class文件格式按照一种类似于C语言的结构体的伪结构来存储数据。这种伪结构中只存在两种数据类型:无符号数和表
   - 无符号数属于基本的数据类型，以u1、u2、u4、u8分别代表1个、2个、4个、8个字节的无符号数。无符号数可以描述数字、索引引用、数量值、按照UTF-8编码构成字符串的值
   - 表:由多个无符号整数或者其他表作为数据项构成的符合数据类型，所有表都习惯以"_info"结尾。表用来描述有层次关系的复合结构的数据
+ Class文件格式

|类型|名称|数量|含义|
|---|---|---|---|
|u4|magic|1|魔数|
|u2|minor_version|1|次版本号|
|u2|major_version|1|主版本号|
|u2|constant_pool_count|1|常量池入口|
|cp_info|constant_pool|constant_pool_count-1|常量池|
|u2|access_flags|1|--|
|u2|this_class|1|---|
|u2|super_class|1|---|
|u2|interfaces_count|1|---|
|u2|interfaces|interfaces_count|----|
|u2|fields_count|1|---|
|field_info|fields|fields_count|---|
|u2|methods_count|1|---|
|method_info|methods|methods_count|---|
|u2|attributes_count|1|---|
|attribute_info|attributes|attributes_count|---|

+ ps:
  - 无论是无符号数或表，当需要描述同一类型但是数量不定的多个数据时，经常会使用一个**前置**的容量计数器加若干个连续(**同一类型**)的数据项的形式。这若干个连续的同一类型的数据项称为一个集合(猜想：这就是class文件中表的组成形式)
### 魔数
+ 唯一的作用就是标识该class文件能够被该JVM加载执行
### 常量池
#### CONSTANT_Class_info
+ 结构

|类型|名称|数量|
|---|---|---|
|u1|tag|1|
|u2|name_index|1|
+ tag:标识位
+ name_index:索引值，指向常量池中一个CONSTANT_Utf8_info类型常量

### CONSTANT_Utf8_info
+ 结构

|类型|名称|数量|
|---|---|---|
|u1|tag|1|
|u2|length|1|
|u1|bytes|length|
+ tag:标识位
+ length:表示该utf-8编码的字符串长度是多少==**字节**==，也就是说，Java中String常量最长为length字节。
+ bytes:使用utf8缩略编码表示的字符串。
   1. Java中String类型常量最大长度为65535
   2. 最长实际为65534,因为编译器javac有限制。
   3. 缩略编码：
      - '\u0001'~'\u007f' 之间的所有字符的缩略编码使用一个字节表示
      - '\u0800'~'\u07ff' 之间的所有字符的缩略编码都使用两个字节表示
      - '\u0800'~'\uffff' 之间所有字符的缩略编码都使用三个字节表示
   4. Java中方法名，类名，变量名均会使用CONSTANT_Utf8_info类型来描述，故长度会有该限制